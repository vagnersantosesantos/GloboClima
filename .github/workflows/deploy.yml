name: Deploy GloboClima (Free Tier)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Debug - Check structure
      run: |
        echo "ðŸ“ Project structure:"
        find . -name "*.csproj" -type f
        ls -la src/
    
    - name: Build Lambda
      run: |
        echo "ðŸ”¨ Building Lambda..."
        
        # âœ… PATH CORRETO: src/GloboClima.Lambda
        cd src/GloboClima.Lambda
        dotnet publish -c Release -r linux-x64 --self-contained true -o publish
        
        # Criar bootstrap
        cd publish
        cat > bootstrap << 'EOF'
        #!/bin/bash
        set -euo pipefail
        exec ./GloboClima.Lambda
        EOF
        chmod +x bootstrap
        
        echo "âœ… Build completed. Files:"
        ls -la
        
        echo "ðŸ“ Full path:"
        pwd
    
    - name: Install SAM CLI
      run: |
        pip install aws-sam-cli
        sam --version
    
    - name: Create SAM Template
      run: |
        echo "ðŸ“ Creating SAM template..."
        
        cat > sam-template.yml << 'EOF'
        AWSTemplateFormatVersion: '2010-09-09'
        Transform: AWS::Serverless-2016-10-31
        Description: 'GloboClima - Deploy Free Tier'

        Parameters:
          JWTSecret:
            Type: String
            NoEcho: true
          OpenWeatherMapApiKey:
            Type: String
            NoEcho: true

        Resources:
          UsersTable:
            Type: AWS::DynamoDB::Table
            Properties:
              TableName: 'GloboClima-Users-dev'
              BillingMode: PAY_PER_REQUEST
              AttributeDefinitions:
                - AttributeName: Id
                  AttributeType: S
              KeySchema:
                - AttributeName: Id
                  KeyType: HASH

          ApiFunction:
            Type: AWS::Serverless::Function
            Properties:
              FunctionName: 'globoclima-dev'
              Runtime: provided.al2023
              CodeUri: ./src/GloboClima.Lambda/publish/
              Handler: bootstrap
              MemorySize: 256
              Timeout: 30
              Environment:
                Variables:
                  DYNAMODB_TABLE_NAME: !Ref UsersTable
                  JWT__SECRET: !Ref JWTSecret
                  JWT__ISSUER: 'GloboClima'
                  JWT__AUDIENCE: 'GloboClima-Users'
                  OPENWEATHERMAP__APIKEY: !Ref OpenWeatherMapApiKey
              Policies:
                - DynamoDBCrudPolicy:
                    TableName: !Ref UsersTable
              Events:
                ApiEvent:
                  Type: Api
                  Properties:
                    Path: /{proxy+}
                    Method: ANY
                RootEvent:
                  Type: Api
                  Properties:
                    Path: /
                    Method: ANY

          FrontendBucket:
            Type: AWS::S3::Bucket
            Properties:
              BucketName: !Sub 'globoclima-dev-${AWS::AccountId}'
              WebsiteConfiguration:
                IndexDocument: index.html
              PublicAccessBlockConfiguration:
                BlockPublicAcls: false
                BlockPublicPolicy: false
                IgnorePublicAcls: false
                RestrictPublicBuckets: false

          BucketPolicy:
            Type: AWS::S3::BucketPolicy
            Properties:
              Bucket: !Ref FrontendBucket
              PolicyDocument:
                Statement:
                  - Effect: Allow
                    Principal: '*'
                    Action: s3:GetObject
                    Resource: !Sub '${FrontendBucket}/*'

        Outputs:
          ApiUrl:
            Value: !Sub 'https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod'
          FrontendUrl:
            Value: !Sub 'http://${FrontendBucket}.s3-website-${AWS::Region}.amazonaws.com'
          BucketName:
            Value: !Ref FrontendBucket
        EOF
        
        echo "âœ… SAM template created"
    
    - name: Deploy Infrastructure
      run: |
        echo "ðŸš€ Starting SAM deploy..."
        
        # âœ… Verificar se pasta existe com path correto
        if [ ! -d "src/GloboClima.Lambda/publish" ]; then
          echo "âŒ Publish folder not found at src/GloboClima.Lambda/publish!"
          echo "ðŸ“ Checking what exists:"
          find . -name "publish" -type d
          exit 1
        fi
        
        sam deploy \
          --template-file sam-template.yml \
          --stack-name globoclima-dev \
          --parameter-overrides \
            JWTSecret="${{ secrets.JWT_SECRET }}" \
            OpenWeatherMapApiKey="${{ secrets.OPENWEATHERMAP_API_KEY }}" \
          --capabilities CAPABILITY_IAM \
          --resolve-s3 \
          --region ${{ env.AWS_REGION }} \
          --no-confirm-changeset \
          --no-fail-on-empty-changeset
    
    - name: Build & Deploy Frontend
      run: |
        echo "ðŸŽ¨ Building frontend..."
        
        # âœ… PATH CORRETO: src/GloboClima.Frontend
        cd src/GloboClima.Frontend
        dotnet publish -c Release -o dist
        
        echo "ðŸ“¤ Uploading frontend..."
        BUCKET=$(aws cloudformation describe-stacks \
          --stack-name globoclima-dev \
          --query 'Stacks[0].Outputs[?OutputKey==`BucketName`].OutputValue' \
          --output text)
        
        echo "Bucket name: $BUCKET"
        aws s3 sync dist/wwwroot/ s3://$BUCKET/ --delete
        
        echo "ðŸŽ‰ Deploy completed!"
        API_URL=$(aws cloudformation describe-stacks \
          --stack-name globoclima-dev \
          --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
          --output text)
        FRONTEND_URL=$(aws cloudformation describe-stacks \
          --stack-name globoclima-dev \
          --query 'Stacks[0].Outputs[?OutputKey==`FrontendUrl`].OutputValue' \
          --output text)
        
        echo "ðŸ“¡ API: $API_URL"
        echo "ðŸŒ Frontend: $FRONTEND_URL"